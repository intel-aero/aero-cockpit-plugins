<head>
    <title>Wifi Network</title>
    <meta charset="utf-8">
    <link href="../base1/cockpit.css" type="text/css" rel="stylesheet">
    <link href="network.css" type="text/css" rel="stylesheet">
    <script src="../base1/jquery.js"></script>
    <script src="../base1/cockpit.js"></script>
</head>
<body>
    <button class="network"  id="1" > Change SSID </button>
    <button class="network" id="2" style='margin-left:0px'> Reset to Default </button>
    <button class="network" id="3" style='margin-left:0px'> Station Mode </button>
    <div class="1" id="div1" >
        <table class="cockpit-form-table">
            <tr>
                <td><label class="control-label" for="new_ssid"> New SSID </label></td>
                <td><input class="form-control" id="new_ssid" value=""></td>
            </tr>
            <tr>
                <td><label class="control-label" for="password"> Password </label></td>
                <td><input class="form-control" id="password" value=""></td>
            </tr>
        </table>
        <button class="btn btn-default btn-primary" id="change_ssid" > Rename SSID </button>
        <span id="result"></span>
        <p>
            <pre id="output"></pre>
        </p>
    </div>

    <div class="2" id="div2" style='display: none'>
        <button id="reset"> Reset SSID </button>
        <p>
            <pre id="output2"></pre>
        </p>
    </div>

    <div class="3" id="div3" style='display:none'>
        <div id="bloc1" style="float: left; display: inline;">
            <br><button id="scan" > Scan </button></br> </div>
        <div id="bloc2">
            <select id="wifi_ssid_list" size=0  style="margin:22px"></select>
        </div>
        <br><table class="cockpit-form-table">
            <tr>
                <td><label class="control-label" for="password_wifi"> Password </label></td>
                <td><input class="form-control" id="password_wifi" value=""></td>
            </tr>
        </table></br>
        <button id="connect" > Connect </button>
        <span id="result"></span>
        <p>
            <pre id="output3"></pre>
        </p>
    </div>
    <script>
        $(".network").bind("click",function() {
            $(".1").hide();
            $(".2").hide();
            $(".3").hide();
            var divId=$(this).attr("id");
            $("."+divId).show();
        });
    </script>

    <script>
        var new_ssid = $("#new_ssid");
        var password = $("#password");
        var output = $("#output");
        var result = $("#result");
        var output2 = $("#output2");
        var output3 = $("#output3");
        var ssid;
        var key_wifi = [];
        var password_wifi = $("#password_wifi");

        $("#change_ssid").on("click", rename_ssid_run);
        $("#scan").on("click", scan_wifi);
        $("#connect").on("click", connect_wifi);

        function rename_ssid_run() {
            var proc = cockpit.spawn(["bash", "/usr/share/cockpit/network/connman-configure-ssid.sh", new_ssid.val(), password.val()]);
            proc.done(rename_ssid_success);
            proc.stream(rename_ssid_output);
            proc.fail(rename_ssid_fail);
            result.empty();
            output.empty();
            output2.empty();
        }

        function rename_ssid_success() {
            output.show();
            output.append("Sucsessfully changed SSID");
        }

        function rename_ssid_fail() {
            result.css("color", "red");
            result.text("Error in changing SSID");
        }

        function rename_ssid_output(data) {
            output.show();
            output.append(document.createTextNode(data));
        }

        $("#reset").on("click", reset_ssid);

        function reset_ssid() {
            var proc=cockpit.spawn(["bash", "/usr/share/cockpit/network/reset_wifi.sh"]);
            proc.done(reset_success);
            proc.fail(reset_fail);
        }

        function reset_success() {
            output2.show();
            output2.append("Reset successfull");
        }

        function reset_fail() {
           output2.show();
           output2.append("Reset Failure");
        }

        function scan_wifi() {
            var select_element = document.getElementById("wifi_ssid_list");
            var length = select_element.options.length;
            output3.empty();
            for (i=length-1;i>=0;i--)
            {
                select_element.remove(i);
            }
            select_element.size=0;
            while(key_wifi.length>0)
            {
                key_wifi.pop();
            }
            var proc = cockpit.spawn(["python", "/usr/share/cockpit/network/scan_wifi.py"]);
            proc.done(scan_wifi_done);
            proc.fail(scan_wifi_fail);
        }

        function scan_wifi_done() {
            output3.show();
            output3.append("Scanning Successfull\n");
            read_file();
        }

        function scan_wifi_fail() {
            output3.show();
            output3.append("Scan unsuccessfull\n");
        }

        function read_file() {
            d = new Date();
            var txtFile = new XMLHttpRequest();
            txtFile.open("GET","output.txt?t="+d.getTime(), true);
            txtFile.setRequestHeader("Cache-Control", "no-cache");
            txtFile.onreadystatechange = function() {
                if (txtFile.readyState == 4 && (txtFile.status == 200 || txtFile.status == 0)) {
                    var lines = txtFile.responseText.split("\n");
                    for(var line = 0; line < lines.length; line++) {
                        var inner_array = [];
                        lines[line]=lines[line].trim();
                        var res=lines[line].split(' ');
                        len=res.length;
                        var key=res[line-1];
                        res=res.slice(0,len-1);
                        res=res.join(" ");
                        inner_array.push(res);
                        inner_array.push(key);
                        key_wifi.push(inner_array);
                        inner_array.pop();
                    }
                    document.getElementById("wifi_ssid_list").size = lines.length-1;
                    for(var i=0; i<lines.length-1; i++)
                    {
                        var ssid=key_wifi[i];
                        $('<option value="'+ssid[0]+'">'+ssid[0]+'</option>').appendTo('#wifi_ssid_list');
                    }
                }
            };
            txtFile.send();
        }

        function connect_wifi() {
            var el = document.getElementById("wifi_ssid_list");
            var str_el = el.options[el.selectedIndex].text;
            str_el = str_el.replace("*A ",'');
            var proc = cockpit.spawn(["python","/usr/share/cockpit/network/connect_wifi.py", str_el, password_wifi.val()]);
            proc.done(connect_wifi_done);
            proc.fail(connect_wifi_fail);
        }

        function connect_wifi_done() {
            output3.append("connection  succesfull\n");
            document.getElementById('password_wifi').value = "";
        }

        function connect_wifi_fail() {
            output3.append("connect:Failure\n");
            document.getElementById('password_wifi').value = "";
        }
    </script>
</body>
